<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Image2STL.Desktop.ViewModels"
        xmlns:controls="using:Image2STL.Desktop.Controls"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        d:DesignWidth="1120"
        d:DesignHeight="760"
        x:Class="Image2STL.Desktop.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="Image2STL">

    <Window.KeyBindings>
        <KeyBinding Gesture="Ctrl+N" Command="{Binding NewProjectCommand}"/>
        <KeyBinding Gesture="Ctrl+S" Command="{Binding SaveProjectCommand}"/>
        <KeyBinding Gesture="Ctrl+G" Command="{Binding GenerateCommand}"/>
    </Window.KeyBindings>

    <Grid ColumnDefinitions="320,*" RowDefinitions="Auto,Auto,*,Auto,Auto" Margin="16" ColumnSpacing="16" RowSpacing="12">
        <Menu Grid.ColumnSpan="2">
            <MenuItem Header="_File">
                <MenuItem Header="_New Project" Click="NewProject_Click" InputGesture="Ctrl+N"/>
                <MenuItem Header="_Open Project..." Click="OpenProject_Click" InputGesture="Ctrl+O"/>
                <MenuItem Header="_Save Project" Click="SaveProject_Click" InputGesture="Ctrl+S"/>
                <MenuItem Header="Save Project _As..." Click="SaveProjectAs_Click"/>
            </MenuItem>
            <MenuItem Header="_Images">
                <MenuItem Header="_Add Images..." Click="AddImages_Click" InputGesture="Ctrl+I"/>
            </MenuItem>
        </Menu>
        <TextBlock Grid.Row="1" Grid.ColumnSpan="2" FontSize="20" FontWeight="SemiBold" Text="Image2STL Desktop MVP" />

        <Border Grid.Row="2" CornerRadius="8" Padding="12" x:Name="DropZone"
                Background="#1F1F1F" BorderBrush="Transparent" BorderThickness="2">
            <DockPanel LastChildFill="True">
                <Button DockPanel.Dock="Bottom" Margin="0,12,0,0" HorizontalAlignment="Stretch" Click="AddImages_Click">Add Images</Button>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Images}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="vm:ImageThumbnailViewModel">
                                <Border Margin="0,0,0,8" Padding="6" CornerRadius="6" Background="#2A2A2A">
                                    <StackPanel>
                                        <Image Source="{Binding Thumbnail}" Width="260" Height="140" Stretch="UniformToFill"/>
                                        <DockPanel Margin="0,6,0,0">
                                            <Button DockPanel.Dock="Right" Padding="8,2" Click="RemoveImage_Click" Tag="{Binding FilePath}">Remove</Button>
                                            <TextBlock VerticalAlignment="Center" Text="{Binding FileName}" TextTrimming="CharacterEllipsis"/>
                                        </DockPanel>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </DockPanel>
        </Border>

        <Border Grid.Row="2" Grid.Column="1" Background="#171717" CornerRadius="8" Padding="8">
            <controls:WireframeViewerControl/>
        </Border>

        <!-- Controls panel: reconstruction mode, scale, action buttons -->
        <StackPanel Grid.Row="3" Grid.ColumnSpan="2" Spacing="8">
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="16">
                <!-- Reconstruction Mode Toggle (SPEC FR3) -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                    <TextBlock Text="Mode:" VerticalAlignment="Center"/>
                    <RadioButton GroupName="ReconstructionMode" Content="Local"
                                 IsChecked="{Binding IsLocalMode}" />
                    <RadioButton GroupName="ReconstructionMode" Content="Cloud"
                                 IsChecked="{Binding IsCloudMode}" />
                </StackPanel>

                <!-- Scale Controls (SPEC FR6) -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <TextBlock Text="Scale (mm):" VerticalAlignment="Center"/>
                    <NumericUpDown Value="{Binding ScaleMm}" Minimum="1" Maximum="10000"
                                   Increment="10" FormatString="F0" Width="100"/>
                    <TextBlock Text="Axis:" VerticalAlignment="Center"/>
                    <ComboBox SelectedItem="{Binding ScaleAxis}" Width="120">
                        <ComboBoxItem Content="longest"/>
                        <ComboBoxItem Content="width"/>
                        <ComboBoxItem Content="height"/>
                        <ComboBoxItem Content="depth"/>
                    </ComboBox>
                </StackPanel>

                <!-- Action Buttons (SPEC FR3, FR7, FR8) -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
                    <Button Content="Generate 3D Model" Click="Generate_Click" Classes="accent"/>
                    <Button Content="Export STL" Click="ExportSTL_Click"/>
                    <Button Content="Cancel" Click="Cancel_Click"
                            IsVisible="{Binding IsProcessing}"/>
                </StackPanel>
            </Grid>

            <!-- Progress Bar (SPEC FR8) -->
            <Grid IsVisible="{Binding IsProcessing}" ColumnDefinitions="*,Auto" ColumnSpacing="8">
                <ProgressBar Grid.Column="0" Value="{Binding Progress}" Minimum="0" Maximum="100"/>
                <TextBlock Grid.Column="1" Text="{Binding ProgressText}" VerticalAlignment="Center"/>
            </Grid>

            <!-- Processing Time Warning (SPEC FR3 / NFR2) -->
            <Border IsVisible="{Binding ShowTimeWarning}" Background="#3FFFBF00" CornerRadius="4" Padding="8,4">
                <TextBlock Text="{Binding TimeWarningText}" Foreground="#FFFFBF00"/>
            </Border>

            <!-- Error Display (SPEC FR9) -->
            <Border IsVisible="{Binding HasError}" Background="#3FFF4444" CornerRadius="4" Padding="8,4">
                <StackPanel Spacing="2">
                    <TextBlock Text="{Binding ErrorMessage}" Foreground="#FFFF6666" FontWeight="SemiBold"/>
                    <TextBlock Text="{Binding ErrorSuggestion}" Foreground="#FFFF9999"/>
                </StackPanel>
            </Border>
        </StackPanel>

        <TextBlock Grid.Row="4" Grid.ColumnSpan="2" Text="{Binding Status}"/>
    </Grid>
</Window>
